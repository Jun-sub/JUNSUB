% dUdc calc%% OCP graph calc & plot

clc, clear, close all;

%% Discharge data: "LGES Natural OCPn"
data_n = [8.52E-06	1.02143996
1.70E-05	1.02130626
2.56E-05	1.02098166
3.41E-05	1.01836543
4.26E-05	1.01582556
5.11E-05	1.01395409
6.25E-05	1.01286559
7.67E-05	1.00797688
9.66E-05	1.00368016
0.000127843	0.99831407
0.000227277	0.98422079
0.000650581	0.94986616
0.00676718	0.69254045
0.017008861	0.5177132
0.027250542	0.4104861
0.037492223	0.3322477
0.047731063	0.2676824
0.057969903	0.2206094
0.068208743	0.2122642
0.078447583	0.2097626
0.088686423	0.2078147
0.098928104	0.2055232
0.109166944	0.2027733
0.119405784	0.1990685
0.129644624	0.1942944
0.139883464	0.1894439
0.150122304	0.1844024
0.160358303	0.1778905
0.170597143	0.1682467
0.180833142	0.160971
0.191071982	0.1561586
0.201307981	0.1514036
0.21154398	0.146935
0.221779979	0.1434021
0.232015978	0.1405186
0.242251977	0.1378451
0.252485135	0.1354579
0.262718293	0.1329182
0.272954292	0.1323071
0.28318745	0.1314095
0.293423449	0.1295189
0.303659448	0.1276474
0.313898288	0.1256423
0.324134287	0.1244202
0.334370286	0.1238854
0.344606285	0.1234653
0.354842284	0.1231407
0.365081124	0.1228924
0.375317123	0.1226442
0.385553122	0.1225487
0.395789121	0.1225105
0.406027961	0.122415
0.416269642	0.1222432
0.426508482	0.1222049
0.436744481	0.1220904
0.44698048	0.1219185
0.457222161	0.1218039
0.467463842	0.1217467
0.477705523	0.1216894
0.487947203	0.1216512
0.498188884	0.1215175
0.508427724	0.1213265
0.518669405	0.1213457
0.528911086	0.1209064
0.539152767	0.1206773
0.549394448	0.1197798
0.559636129	0.1182138
0.56987781	0.1137643
0.580119491	0.1062211
0.590361172	0.0986208
0.600602853	0.0930064
0.610844534	0.0896264
0.621086215	0.0875066
0.631327896	0.0861699
0.641569577	0.0852914
0.651811258	0.0851005
0.662052939	0.0846994
0.672294619	0.0843366
0.682533459	0.0840501
0.692772299	0.0839737
0.703011139	0.0837446
0.713249979	0.0835917
0.723488819	0.083439
0.733727659	0.0834008
0.743966499	0.0831144
0.75420818	0.0830189
0.764449861	0.0827897
0.774691542	0.0825797
0.784933223	0.0825987
0.795174904	0.0824842
0.805416585	0.0825224
0.815658266	0.0825987
0.825899947	0.0825606
0.836138787	0.0823505
0.846377627	0.0823123
0.856616467	0.0821786
0.866855307	0.0821022
0.877094147	0.0818731
0.887332987	0.0816057
0.897574668	0.0813957
0.907816349	0.081243
0.918060871	0.0811475
0.928305392	0.08067
0.938549914	0.0803454
0.948794436	0.0801353
0.959036117	0.0797916
0.969277798	0.0793142
0.979519479	0.078684
0.989758319	0.077882
1	0.0760677
];


%% Discharge data: "LGES Natural OCPn"
data_p = [8.52289253439504e-06	3.5300788
1.70457892965422e-05	3.5295439
2.55686860586894e-05	3.528971
3.40915828208365e-05	3.5283602
4.26144795829837e-05	3.5278256
5.11373763451308e-05	3.5269474
6.25012386947024e-05	3.5259352
7.67060666316983e-05	3.5250383
9.65928257435431e-05	3.5238928
0.000127843	3.522442
0.000227277	3.5204957
0.000650581	3.5175968
0.00676718	3.5193666
0.017008861	3.5224401
0.027250542	3.5261201
0.037492223	3.5288991
0.047731063	3.5273219
0.057969903	3.5273275
0.068208743	3.5526727
0.078447583	3.5744651
0.088686423	3.586612
0.098928104	3.5945385
0.109166944	3.6004212
0.119405784	3.6049097
0.129644624	3.6079853
0.139883464	3.610889
0.150122304	3.6140793
0.160358303	3.6178997
0.170597143	3.6232865
0.180833142	3.6307364
0.191071982	3.6392739
0.201307981	3.6480792
0.21154398	3.6553565
0.221779979	3.6619843
0.232015978	3.6683443
0.242251977	3.674953
0.252485135	3.6821726
0.262718293	3.6884757
0.272954292	3.6962107
0.28318745	3.7039075
0.293423449	3.7100194
0.303659448	3.716074
0.313898288	3.7221668
0.324134287	3.7279923
0.334370286	3.7336836
0.344606285	3.7396999
0.354842284	3.7452767
0.365081124	3.7510829
0.375317123	3.7568892
0.385553122	3.7625998
0.395789121	3.7684439
0.406027961	3.7745746
0.416269642	3.7806671
0.426508482	3.78739
0.436744481	3.7942846
0.44698048	3.8015614
0.457222161	3.8092583
0.467463842	3.8177002
0.477705523	3.8265617
0.487947203	3.8359776
0.498188884	3.8458708
0.508427724	3.8559931
0.518669405	3.866154
0.528911086	3.8764101
0.539152767	3.887029
0.549394448	3.8977626
0.559636129	3.9092415
0.56987781	3.9197844
0.580119491	3.9282268
0.590361172	3.9351228
0.600602853	3.9416552
0.610844534	3.9488178
0.621086215	3.9561327
0.631327896	3.9637917
0.641569577	3.9714504
0.651811258	3.9793001
0.662052939	3.9865194
0.672294619	3.9933377
0.682533459	4.0004042
0.692772299	4.0078912
0.703011139	4.015569
0.713249979	4.0239916
0.723488819	4.0330637
0.733727659	4.0432814
0.743966499	4.0540152
0.75420818	4.0656655
0.764449861	4.0779078
0.774691542	4.0901123
0.784933223	4.1022206
0.795174904	4.1136992
0.805416585	4.124261
0.815658266	4.1335621
0.825899947	4.1413737
0.836138787	4.1475232
0.846377627	4.1520689
0.856616467	4.1553731
0.866855307	4.1576455
0.877094147	4.1594985
0.887332987	4.1612366
0.897574668	4.1630316
0.907816349	4.1654189
0.918060871	4.1682652
0.928305392	4.1716073
0.938549914	4.1761148
0.948794436	4.181959
0.959036117	4.1896368
0.969277798	4.1995299
0.979519479	4.2134722
0.989758319	4.2323802
1	4.2592142
];

% Only dU calculation

soc_range = 0:0.01:1;

data_n_interp = interp1(data_n(:,1),data_n(:,2),soc_range);
data_n = data_n_interp;

data_p_interp = interp1(data_p(:,1),data_p(:,2),soc_range);
data_p = data_p_interp;

figure()
t = tiledlayout(2,2,"TileSpacing","compact","Padding","compact");

nexttile % Anode
plot(soc_range,data_n,'b:','LineWidth',1.5);
xlabel('soc')
ylabel('Voltage')
title('Anode OCP')
set(gca,'PlotBoxAspectRatio',[1 1 1], 'Box','on','xgrid','on','ygrid','on')

nexttile % Cathode
plot(soc_range,data_p,'r:','LineWidth',1.5)
xlabel('soc')
ylabel('Voltage')
title('Cathode OCP')
set(gca,'PlotBoxAspectRatio',[1 1 1], 'Box','on','xgrid','on','ygrid','on','XDir','reverse')

nexttile % Anode OCP diff
plot(soc_range(1:end-1),diff(data_n),'b:','LineWidth',1.5);
xlabel('soc')
ylabel('dU')
title('Anode OCP')
set(gca,'PlotBoxAspectRatio',[1 1 1], 'Box','on','xgrid','on','ygrid','on')

nexttile % Cathode OCP diff
plot(soc_range(1:end-1),diff(data_p),'r:','LineWidth',1.5)
xlabel('soc')
ylabel('dU')
title('Cathode OCP')
set(gca,'PlotBoxAspectRatio',[1 1 1], 'Box','on','xgrid','on','ygrid','on','XDir','reverse')

set(gcf,"Position",[300 100 1200 1200])

% dUdC calculation
soc = -0.2:0.01:1.2;

x_1 = 0.8781; % anode stoic when soc =0
x_0 = 0.0216; % anode stoic when soc =1


y_0 = 0.9319; % cathode stoic when soc =0
y_1 = 0.3532; % cathode stoic when soc =1

cta = 29626;                        ctc = 48786;            % [mol/m3]

type_anode = 0; % 0 for base, 1 for natural, 2 for blend
for k = 1:length(soc)

    % x(k) = -0.025 + x_0 + (x_1 - x_0)*soc(k); % anode stoic
   
    x(k) = x_0 + (x_1 - x_0)*soc(k); % anode stoic
    y(k) = y_0 + (y_1 - y_0)*soc(k); % cathode stoic

    dx = 0.0001; % finite difference step size.
    chg = 0.5; % amount weighting on charging curve wrpt discharging.
    % dUdcc(k) = (1/ctc)*(Uc_function_v3(y(k)+dx,chg) - Uc_function_v3(y(k)-dx,chg))/(2*dx);   % {modified}
    % dUdca(k) = ((1/cta)*(Ua_function_v3(x(k)+dx,chg) - Ua_function_v3(x(k)-dx,chg))/(2*dx))-9.687888232955855e-06;%4.187888232955855e-06;    % *+*
     
    dUdcc(k) = -((1/ctc)*(Uc_function_v3(soc(k)+dx) - Uc_function_v3(soc(k)-dx))/(2*dx));   % {modified}
    dUdca(k) = -((1/cta)*(Ua_function_v3(soc(k)+dx) - Ua_function_v3(soc(k)-dx))/(2*dx));

    % plateau1_start = 0.07; %for dUdca plateau setting
    % plateau1_end = 0.15;
    % 
    % plateau2_start = 0.18;
    % plateau2_end = 0.50;
    % 
    % plateau3_start = 0.51;
    % plateau3_end = 0.98;
    % 
    % 
    % if (plateau1_start <= soc(k)) && (soc(k) <= plateau1_end) %soc 0.07 - 0.15
    %    dUdca(k) = (1/cta)*(Ua_function_v2(plateau1_end,chg) - Ua_function_v2(plateau1_start,chg))/(plateau1_end-plateau1_start);
    % elseif (plateau2_start <= soc(k)) && (soc(k) <= plateau2_end) % soc 0.18 - 0.50
    %    dUdca(k) = (1/cta)*(Ua_function_v2(plateau2_end,chg) - Ua_function_v2(plateau2_start,chg))/(plateau2_end-plateau2_start);
    % elseif (plateau3_start <= soc(k)) && (soc(k) <= plateau3_end) % 0.51 - 00.98
    %    dUdca(k) = (1/cta)*(Ua_function_v2(plateau3_end,chg) - Ua_function_v2(plateau3_start,chg))/(plateau3_end-plateau3_start);
    % else 
    %    dUdca(k) = (1/cta)*(Ua_function_v2(x(k)+dx,chg) - Ua_function_v2(x(k)-dx,chg))/(2*dx);    % *+*
    % end 

end

% plot dUdc plot
figure()
t = tiledlayout(1,2,"TileSpacing","compact","Padding","compact");

nexttile % anode dudc
plot(soc,-dUdca,'b:','LineWidth',1.5);

y_lim = max(abs(dUdca))*1.1;
y_min = min(abs(dUdca))*0.90;

xlabel('soc')
ylabel('dUdc')
title('Anode dUdc')
set(gca,'PlotBoxAspectRatio',[1 1 1], 'Box','on','xgrid','on','ygrid','on','XLim',[-0.2 1.2],'YLim',[-y_lim 1e-4])

nexttile % cathode dudc
plot(soc,dUdcc,'r:','LineWidth',1.5);

y_lim = max(abs(dUdcc))*1.02;
y_min = min(abs(dUdcc))*0.98;

xlabel('soc')
ylabel('dUdc')
title('Cathode dUdc')
set(gca,'PlotBoxAspectRatio',[1 1 1], 'Box','on','xgrid','on','ygrid','on','XLim',[-0.2 1.2],'YLim',[-y_lim 1e-4])

set(gcf,"Position",[100 100 1200 600])